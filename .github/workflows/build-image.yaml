name: Build Container Image

on:
  workflow_call:
    inputs:
      tag:
        description: 'Image tag'
        required: true
        type: string
      additional_tags:
        description: 'Additional tags (comma-separated)'
        required: false
        type: string
        default: ''
      platforms:
        description: 'Target platforms'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64,linux/s390x'
      version:
        description: 'Version to embed in binary'
        required: false
        type: string
        default: ''
      ref:
        description: 'Git ref to checkout (defaults to triggering ref)'
        required: false
        type: string
        default: ''
    outputs:
      image_ref:
        description: 'Full image reference'
        value: ${{ jobs.build.outputs.image_ref }}
      image_tag:
        description: 'Image tag used'
        value: ${{ jobs.build.outputs.image_tag }}
    secrets:
      QUAY_USERNAME:
        required: false
      QUAY_PASSWORD:
        required: false

env:
  GO_VERSION: '1.25'
  KO_DOCKER_REPO: quay.io/karpenter-provider-ibm-cloud/controller

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_ref: ${{ steps.build.outputs.image_ref }}
      image_tag: ${{ inputs.tag }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install ko
        uses: ko-build/setup-ko@v0.6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and push image
        id: build
        run: |
          # Set version ldflags if provided
          if [ -n "${{ inputs.version }}" ]; then
            export GOFLAGS="-ldflags=-X main.version=${{ inputs.version }}"
          fi

          # Build all tags in single ko build call
          ALL_TAGS="${{ inputs.tag }}"
          if [ -n "${{ inputs.additional_tags }}" ]; then
            ALL_TAGS="${ALL_TAGS},${{ inputs.additional_tags }}"
          fi

          echo "Building with tags: $ALL_TAGS"
          ko build \
            --platform=${{ inputs.platforms }} \
            --bare \
            --tags=$ALL_TAGS \
            ./cmd/controller

          echo "image_ref=$KO_DOCKER_REPO:${{ inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Verify manifest
        run: |
          echo "Verifying manifest for $KO_DOCKER_REPO:${{ inputs.tag }}..."
          docker buildx imagetools inspect $KO_DOCKER_REPO:${{ inputs.tag }}
